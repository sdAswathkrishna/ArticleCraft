<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Article - ArticleCraft</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="navbar-brand">
                    <a href="/">ArticleCraft</a>
                </div>
                
                <div class="navbar-menu">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="/" class="nav-link">Home</a>
                        </li>
                        <li class="nav-item" id="write-nav" style="display: none;">
                            <a href="/write" class="nav-link">Write</a>
                        </li>
                        <li class="nav-item" id="generate-nav" style="display: none;">
                            <a href="/generate" class="nav-link">Generate</a>
                        </li>
                    </ul>
                </div>
                
                <div class="navbar-end">
                    <div id="auth-buttons">
                        <a href="/login" class="btn btn-outline">Login</a>
                        <a href="/register" class="btn btn-primary">Register</a>
                    </div>
                    <div id="user-dropdown" class="user-dropdown" style="display: none;">
                        <button class="dropdown-toggle">
                            <span class="user-name" id="username-display"></span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/profile" class="dropdown-item">
                                <i class="fas fa-user"></i> Profile
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading article...</p>
            </div>
            
            <div id="article-content" class="article-container" style="display: none;">
                <article class="main-article">
                    <div class="article-header">
                        <h1 id="article-title"></h1>
                        <div class="article-meta">
                            <span class="author">By <span id="article-author"></span></span>
                            <span class="timestamp" id="article-timestamp"></span>
                            <span class="generated-badge" id="generated-badge" style="display: none;">AI Generated</span>
                        </div>
                        <div class="tags" id="article-tags" style="display: none;"></div>
                    </div>
                    
                    <div class="article-content" id="article-body"></div>
                    
                    <div class="article-actions">
                        <div class="engagement">
                            <span class="views-count" id="views-count">0 views</span>
                            <button class="like-button" id="like-button">
                                <span class="like-icon">❤️</span>
                                <span class="like-count" id="like-count">0</span>
                            </button>
                        </div>
                        <div class="share">
                            <button class="share-button" id="share-button">Share</button>
                            <div class="share-dropdown" id="share-dropdown">
                                <a href="#" class="twitter-share" id="twitter-share">Twitter</a>
                                <a href="#" class="facebook-share" id="facebook-share">Facebook</a>
                                <a href="#" class="linkedin-share" id="linkedin-share">LinkedIn</a>
                                <a href="#" class="copy-link" id="copy-link">Copy Link</a>
                            </div>
                        </div>
                    </div>
                </article>
                
                <aside class="recommendations">
                    <h3>Recommended Articles</h3>
                    <div class="recommended-articles" id="recommendations-container">
                        <p>Loading recommendations...</p>
                    </div>
                </aside>
            </div>
            
            <div id="error-message" style="display: none;">
                <div class="alert alert-error">
                    <p>Article not found or failed to load.</p>
                    <a href="/" class="btn btn-primary">Go back to home</a>
                </div>
            </div>
        </div>
    </main>
    
    <script src="/static/auth.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let currentArticle = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadArticle();
            setupEventListeners();
        });

        function getArticleIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        async function loadArticle() {
            const articleId = getArticleIdFromUrl();
            
            try {
                const response = await fetch(`${API_BASE_URL}/articles/${articleId}`);
                
                if (!response.ok) {
                    throw new Error('Article not found');
                }
                
                const article = await response.json();
                currentArticle = article;
                displayArticle(article);
                loadRecommendations(article.title);
                recordView(articleId);
                
            } catch (error) {
                console.error('Error loading article:', error);
                showError();
            }
        }

        function displayArticle(article) {
            // Update page title
            document.getElementById('page-title').textContent = `${article.title} - ArticleCraft`;
            
            // Fill article content
            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-author').textContent = article.author?.username || 'Unknown';
            document.getElementById('article-timestamp').textContent = formatDate(article.timestamp);
            document.getElementById('article-body').innerHTML = article.content;
            
            // Show generated badge if AI generated
            if (article.generated) {
                document.getElementById('generated-badge').style.display = 'inline';
            }
            
            // Display tags
            if (article.tags) {
                const tagsContainer = document.getElementById('article-tags');
                const tags = article.tags.split(',').map(tag => 
                    `<span class="tag">${tag.trim()}</span>`
                ).join('');
                tagsContainer.innerHTML = tags;
                tagsContainer.style.display = 'flex';
            }
            
            // Update engagement numbers
            document.getElementById('views-count').textContent = `${article.views || 0} views`;
            document.getElementById('like-count').textContent = article.likes || 0;
            
            // Show article content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('article-content').style.display = 'grid';
            
            // Setup share links
            setupShareLinks(article);
        }

        async function loadRecommendations(title) {
            try {
                const response = await fetch(`${API_BASE_URL}/recommendations/?title=${encodeURIComponent(title)}`);
                
                if (response.ok) {
                    const recommendations = await response.json();
                    displayRecommendations(recommendations);
                } else {
                    document.getElementById('recommendations-container').innerHTML = 
                        '<p>No recommendations available.</p>';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendations-container').innerHTML = 
                    '<p>Failed to load recommendations.</p>';
            }
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations-container');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<p>No recommendations available.</p>';
                return;
            }
            
            const recommendationsHtml = recommendations.map(rec => `
                <div class="recommended-article">
                    <h4><a href="/article/${rec.id}">${rec.title}</a></h4>
                    <p>${truncateText(stripHtml(rec.content), 150)}...</p>
                </div>
            `).join('');
            
            container.innerHTML = recommendationsHtml;
        }

        async function recordView(articleId) {
            try {
                await fetch(`${API_BASE_URL}/articles/${articleId}/view`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Error recording view:', error);
            }
        }

        function setupEventListeners() {
            // Like button
            document.getElementById('like-button').addEventListener('click', async function() {
                if (!currentArticle) return;
                
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        alert('Please log in to like articles');
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/articles/${currentArticle.id}/like`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const likeCount = document.getElementById('like-count');
                        const currentLikes = parseInt(likeCount.textContent);
                        likeCount.textContent = currentLikes + 1;
                        
                        // Visual feedback
                        this.classList.add('liked');
                        setTimeout(() => this.classList.remove('liked'), 500);
                    }
                } catch (error) {
                    console.error('Error liking article:', error);
                }
            });
            
            // Share functionality
            const shareButton = document.getElementById('share-button');
            const shareDropdown = document.getElementById('share-dropdown');
            
            shareButton.addEventListener('click', function() {
                shareDropdown.classList.toggle('active');
            });
            
            // Hide dropdown when clicking elsewhere
            document.addEventListener('click', function(event) {
                if (!shareButton.contains(event.target) && !shareDropdown.contains(event.target)) {
                    shareDropdown.classList.remove('active');
                }
            });
            
            // Copy link functionality
            document.getElementById('copy-link').addEventListener('click', function(e) {
                e.preventDefault();
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(function() {
                    const originalText = e.target.textContent;
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = originalText, 2000);
                });
            });
        }

        function setupShareLinks(article) {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(article.title);
            
            document.getElementById('twitter-share').href = 
                `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
            document.getElementById('facebook-share').href = 
                `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            document.getElementById('linkedin-share').href = 
                `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength);
        }
    </script>
</body>
</html>