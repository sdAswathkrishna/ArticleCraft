<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - ArticleCraft</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="navbar-brand">
                    <a href="/">ArticleCraft</a>
                </div>
                
                <div class="navbar-menu">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="/" class="nav-link">Home</a>
                        </li>
                        <li class="nav-item">
                            <a href="/write" class="nav-link">Write</a>
                        </li>
                        <li class="nav-item">
                            <a href="/generate" class="nav-link">Generate</a>
                        </li>
                    </ul>
                </div>
                
                <div class="navbar-end">
                    <div class="user-dropdown">
                        <button class="dropdown-toggle">
                            <span class="user-name" id="username-display">User</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/profile" class="dropdown-item">
                                <i class="fas fa-user"></i> Profile
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading profile...</p>
            </div>
            
            <div id="profile-content" class="profile-container" style="display: none;">
                <div class="profile-header">
                    <h1 id="profile-username">User's Profile</h1>
                    <div class="profile-meta">
                        <p>Member since: <span id="member-since"></span></p>
                        <p>Email: <span id="user-email"></span></p>
                    </div>
                </div>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-number" id="total-articles">0</div>
                        <div class="stat-label">Articles Published</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ai-generated">0</div>
                        <div class="stat-label">AI-Generated</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-views">0</div>
                        <div class="stat-label">Total Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-likes">0</div>
                        <div class="stat-label">Total Likes</div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Content Type Distribution</h3>
                        <div class="chart-container">
                            <canvas id="contentTypeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Monthly Activity</h3>
                        <div class="chart-container">
                            <canvas id="monthlyActivityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="articles-section">
                    <h2>Your Articles</h2>
                    
                    <div id="articles-table-container" style="display: none;">
                        <div class="articles-table-container">
                            <table class="articles-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Date</th>
                                        <th>Views</th>
                                        <th>Likes</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody id="articles-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="no-articles" class="no-articles" style="display: none;">
                        <p>You haven't published any articles yet.</p>
                        <div class="cta-buttons">
                            <a href="/write" class="btn btn-primary">✍ Write an Article</a>
                            <a href="/generate" class="btn btn-success">⚡ Generate an Article</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error-message" style="display: none;">
                <div class="alert alert-error">
                    <p>Failed to load profile. Please try again.</p>
                    <button class="btn btn-primary" onclick="loadProfile()">Retry</button>
                </div>
            </div>
        </div>
    </main>
    
    <script src="/static/auth.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let userArticles = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadProfile();
        });

        async function loadProfile() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                // Load user profile
                const userResponse = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('Failed to load user profile');
                }
                
                const user = await userResponse.json();
                
                // Load user articles
                const articlesResponse = await fetch(`${API_BASE_URL}/users/me/articles`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!articlesResponse.ok) {
                    throw new Error('Failed to load user articles');
                }
                
                const articles = await articlesResponse.json();
                userArticles = articles;
                
                displayProfile(user, articles);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showError();
            }
        }

        function displayProfile(user, articles) {
            // Update profile header
            document.getElementById('profile-username').textContent = `${user.username}'s Profile`;
            document.getElementById('member-since').textContent = formatDate(user.created_at);
            document.getElementById('user-email').textContent = user.email;
            
            // Calculate statistics
            const totalArticles = articles.length;
            const aiGenerated = articles.filter(a => a.generated).length;
            const totalViews = articles.reduce((sum, a) => sum + (a.views || 0), 0);
            const totalLikes = articles.reduce((sum, a) => sum + (a.likes || 0), 0);
            
            // Update stats cards
            document.getElementById('total-articles').textContent = totalArticles;
            document.getElementById('ai-generated').textContent = aiGenerated;
            document.getElementById('total-views').textContent = totalViews;
            document.getElementById('total-likes').textContent = totalLikes;
            
            // Display articles
            displayArticlesTable(articles);
            
            // Create charts
            createCharts(articles);
            
            // Show profile content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';
        }

        function displayArticlesTable(articles) {
            if (articles.length === 0) {
                document.getElementById('no-articles').style.display = 'block';
                return;
            }
            
            const tableBody = document.getElementById('articles-table-body');
            const articlesHtml = articles.map(article => `
                <tr>
                    <td><a href="/article/${article.id}">${article.title}</a></td>
                    <td>${formatDate(article.timestamp)}</td>
                    <td>${article.views || 0}</td>
                    <td>${article.likes || 0}</td>
                    <td>${article.generated ? 'AI Generated' : 'Written'}</td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = articlesHtml;
            document.getElementById('articles-table-container').style.display = 'block';
        }

        function createCharts(articles) {
            createContentTypeChart(articles);
            createMonthlyActivityChart(articles);
        }

        function createContentTypeChart(articles) {
            const generatedCount = articles.filter(a => a.generated).length;
            const writtenCount = articles.length - generatedCount;
            
            const ctx = document.getElementById('contentTypeChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Written', 'AI Generated'],
                    datasets: [{
                        data: [writtenCount, generatedCount],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        function createMonthlyActivityChart(articles) {
            const monthlyData = {};
            
            articles.forEach(article => {
                if (!article.timestamp) return;
                
                const date = new Date(article.timestamp);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear]++;
            });
            
            const labels = Object.keys(monthlyData).sort((a, b) => {
                const [aMonth, aYear] = a.split('/');
                const [bMonth, bYear] = b.split('/');
                return new Date(aYear, aMonth - 1) - new Date(bYear, bMonth - 1);
            });
            
            const data = labels.map(label => monthlyData[label]);
            
            const ctx = document.getElementById('monthlyActivityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Articles Published',
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html>